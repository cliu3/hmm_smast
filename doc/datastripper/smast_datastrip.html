<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of smast_datastrip</title>
  <meta name="keywords" content="smast_datastrip">
  <meta name="description" content="close all; clear all;">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">datastripper</a> &gt; smast_datastrip.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for datastripper&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>smast_datastrip
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>close all; clear all;</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function smast_datastrip(tagdata,dt) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">close all; clear all;
load ../tag_data/S10440;
tagdata = tag;
 function smast_datastrip

 read tag data structure generated by readtag (see readtag.m)

 DESCRIPTION:
  Read a tag data structure created by readtag.m
  Sample the tag data at a discrete time step
  Shift the time to yearday
  Plot some stuff

 INPUT
  tagdata:  path to an SMAST-format tag text file
  dt:  time step in minutes.  This argument is optional.  If it is not present
       hmm will use the max timestep from the SMAST-format tag file

 OUTPUT:
    fvcomdb.mat

 EXAMPLE USAGE
    smast_datastrip(tagdata,dt)

 Author(s):  
    Martin Pedersen

 Revision History
    8/2010: Klavdija Jenko (UMASSD):  modified routine to read in tag structure
                                      generated by readtag
 Revision History
    5/2012: Geoff Cowles (UMASSD):  modified to read Matlab-based SMAST tags
==============================================================================</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="../tbworkdir/run_tag.html" class="code" title="">run_tag</a>	clear all;</li><li><a href="../test/run_tag.html" class="code" title="">run_tag</a>	clear all;</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function smast_datastrip(tagdata,dt)</a>
0002 <span class="comment">%close all; clear all;</span>
0003 <span class="comment">%load ../tag_data/S10440;</span>
0004 <span class="comment">%tagdata = tag;</span>
0005 <span class="comment">% function smast_datastrip</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% read tag data structure generated by readtag (see readtag.m)</span>
0008 <span class="comment">%</span>
0009 <span class="comment">% DESCRIPTION:</span>
0010 <span class="comment">%  Read a tag data structure created by readtag.m</span>
0011 <span class="comment">%  Sample the tag data at a discrete time step</span>
0012 <span class="comment">%  Shift the time to yearday</span>
0013 <span class="comment">%  Plot some stuff</span>
0014 <span class="comment">%</span>
0015 <span class="comment">% INPUT</span>
0016 <span class="comment">%  tagdata:  path to an SMAST-format tag text file</span>
0017 <span class="comment">%  dt:  time step in minutes.  This argument is optional.  If it is not present</span>
0018 <span class="comment">%       hmm will use the max timestep from the SMAST-format tag file</span>
0019 <span class="comment">%</span>
0020 <span class="comment">% OUTPUT:</span>
0021 <span class="comment">%    fvcomdb.mat</span>
0022 <span class="comment">%</span>
0023 <span class="comment">% EXAMPLE USAGE</span>
0024 <span class="comment">%    smast_datastrip(tagdata,dt)</span>
0025 <span class="comment">%</span>
0026 <span class="comment">% Author(s):</span>
0027 <span class="comment">%    Martin Pedersen</span>
0028 <span class="comment">%</span>
0029 <span class="comment">% Revision History</span>
0030 <span class="comment">%    8/2010: Klavdija Jenko (UMASSD):  modified routine to read in tag structure</span>
0031 <span class="comment">%                                      generated by readtag</span>
0032 <span class="comment">% Revision History</span>
0033 <span class="comment">%    5/2012: Geoff Cowles (UMASSD):  modified to read Matlab-based SMAST tags</span>
0034 <span class="comment">%==============================================================================</span>
0035 
0036 <span class="comment">% set the time step (use argument dt if present)</span>
0037 <span class="keyword">if</span> nargin &lt; 2, dt = tagdata.max_intvl_seconds/60; <span class="keyword">end</span>; 
0038 
0039 td.deltat = dt;
0040 
0041 <span class="comment">%-------------------------------------------------------------------</span>
0042 <span class="comment">% Set tag timeseries of time and depth, tag number, and time step</span>
0043 <span class="comment">%-------------------------------------------------------------------</span>
0044 <span class="comment">%td.dt = int(dt);</span>
0045 <span class="keyword">if</span> isfield(tagdata,<span class="string">'fish_id'</span>)
0046     td.tagno = [num2str(tagdata.fish_id) <span class="string">'_'</span>  tagdata.tag_id];
0047 <span class="keyword">else</span>
0048     td.tagno = tagdata.tag_id;
0049 <span class="keyword">end</span>
0050 td.unit = <span class="string">'m'</span>;
0051 td.time_org = tagdata.dnum;
0052 td.depth_org = -tagdata.depth; <span class="comment">%depth of tag record is positive up</span>
0053 td.temp_org =tagdata.temp ;
0054 td.time = []; td.depth = []; td.temp = [];
0055 disp(sprintf(<span class="string">'\n\n=== Commencing datastrip for tag #%s ==='</span>,td.tagno))
0056 
0057 <span class="comment">%-------------------------------------------------------------------</span>
0058 <span class="comment">% Set release/recapture/recapture uncertainty information</span>
0059 <span class="comment">%-------------------------------------------------------------------</span>
0060 td.rel_long   = tagdata.release_lon;
0061 td.rel_lat    = tagdata.release_lat;
0062 td.catch_long = tagdata.recapture_lon;
0063 td.catch_lat  = tagdata.recapture_lat;
0064 td.catch_unc  = tagdata.recap_uncertainty_km;  
0065 
0066 
0067 <span class="comment">% Initialise time and depth records</span>
0068 td.depth = td.depth_org;
0069 td.time = td.time_org;
0070 plot(td.time_org-td.time_org(1))
0071 figure
0072 plot(td.time_org-td.time_org(1),td.depth)
0073 figure
0074 plot(diff(td.time_org)*60*24) 
0075 title(<span class="string">'time interval from raw tag time (minutes)'</span>)
0076 figure
0077 datestr(td.time_org(1))
0078 datestr(td.time_org(end))
0079 
0080 <span class="comment">% gwc - note</span>
0081 <span class="comment">% this subsampling is a mess, converting to integers and comparing will still suffer</span>
0082 <span class="comment">% from floating point depending on the format of the raw tag time</span>
0083 <span class="comment">% we should consider either resplining the raw data to a common time (why would that be bad)</span>
0084 <span class="comment">% or transferring to the common time with an exact threshold (within +/- a few seconds is fine)</span>
0085 <span class="comment">% fixed - CL 5/26/2016</span>
0086 
0087 <span class="comment">% Subsample in 'dt' min sample intervals</span>
0088 disp(<span class="string">'Subsampling...'</span>)
0089 SF = 1/(24*60/dt); <span class="comment">% Sample frequency in days</span>
0090 td.time = td.time(1):SF:td.time(end);
0091 save junk td
0092 <span class="comment">% integer vectors containing sample freq time and original time</span>
0093 t  = round(td.time_org*1e7);
0094 tn = round(td.time*1e7);
0095 <span class="comment">% allocate space for depth and temperature on subsample time vector</span>
0096 td.depth = zeros(1,length(tn));
0097 td.temp = zeros(1,length(tn));
0098 <span class="keyword">if</span> isempty(td.temp_org), td.temp_org = zeros(1,length(td.depth_org)); <span class="keyword">end</span>  <span class="comment">%no temp data in tag, make fake temp data</span>
0099 j = 1; p=0;
0100 
0101 <span class="comment">%if SF &lt; max(diff(td.time_org)), disp(sprintf('There might be missing data or selected sample rate, %3.1fmin, is faster than data i.e. data is removed!',dt)), pause(0.01), end</span>
0102 <span class="comment">% gwc, deal with precision problem</span>
0103 <span class="keyword">if</span> (diff(td.time_org) - SF &gt; 1./(24*3600)  ), disp(sprintf(<span class="string">'There might be missing data or selected sample rate, %3.1fmin, is faster than data i.e. data is removed!'</span>,dt)), pause(0.01), <span class="keyword">end</span>
0104 <span class="comment">% subsampling does not interpolate.  If time from the raw matches exactly (using the integer) subsample time, then it will use the data</span>
0105 <span class="comment">% from the tag at that time.  If it finds no time stamp at that time, it will give it no data and give an eror</span>
0106 <span class="comment">% thus, the subsample time (dt) must be an integer multiple of the largest time interval from the raw tag</span>
0107 mis = 0;
0108 <span class="keyword">for</span> i=1:length(tn)
0109     k=0; f=0;
0110     <span class="keyword">while</span> k&lt;dt*(6+1) &amp;&amp; f~=1
0111 <span class="comment">%        if tn(i) == t(j)</span>
0112         <span class="keyword">if</span> (abs(tn(i) - t(j)) &lt; 1000) <span class="comment">%time stamps are within a second should be OK</span>
0113             td.depth(i) = td.depth_org(j);
0114             td.temp(i) = td.temp_org(j);
0115             f=1;
0116         <span class="keyword">elseif</span> tn(i) &lt; t(j) <span class="comment">% if data missing</span>
0117             tn(i)       = []; <span class="comment">% remove expected data</span>
0118             td.time(i)  = []; <span class="comment">% remove expected data</span>
0119             td.depth(i) = []; <span class="comment">% remove expected data</span>
0120             td.temp(i)  = []; <span class="comment">% remove expected data</span>
0121             j=j-1;
0122             mis = mis + 1;
0123             <span class="keyword">if</span> mis == 1000, disp(<span class="string">'Program execution might be slow due to missing data, or badly selected sample rate!'</span>),pause(0.01), <span class="keyword">end</span>
0124         <span class="keyword">end</span>
0125         k=k+1; 
0126         j=j+1;
0127     <span class="keyword">end</span>
0128     <span class="keyword">if</span> j&gt;length(td.time_org), <span class="keyword">break</span>, <span class="keyword">end</span>
0129 <span class="keyword">end</span>
0130 disp(sprintf(<span class="string">'...subsampling removed %i datapoints.'</span>,length(td.time_org)-length(td.time)))
0131 
0132 
0133 <span class="comment">% Make td.time_plot and shift td.time</span>
0134 year = str2num(datestr(td.time(1),10)); 
0135 td.time_plot = td.time;
0136 td.time = td.time - datenum(year,1,1,0,0,0);
0137 
0138 <span class="comment">% Creating *.mat file</span>
0139 filename = sprintf(<span class="string">'raw%s'</span>,td.tagno);
0140 disp(sprintf(<span class="string">'Saving -&gt; %s.mat &lt;- in\n%s'</span>,filename,cd))
0141 save(filename,<span class="string">'td'</span>)
0142 disp(sprintf(<span class="string">'\nDONE with datastrip! \n\nNow run --&gt; tidebehavextr \n\nto create/update tidal and behaviour extraction!\n'</span>))
0143 
0144 <span class="comment">%% Plot result %%</span>
0145 plot(td.time_org,td.depth_org,<span class="string">'-'</span>), datetick(<span class="string">'x'</span>,<span class="string">'QQ-YY'</span>)
0146 xlabel(<span class="string">'Date'</span>), ylabel(sprintf(<span class="string">'Unit: %s'</span>,<span class="string">'Depth [m]'</span>))
0147 title(sprintf(<span class="string">'Unprocessed depth record for tag #%s'</span>,td.tagno))
0148 figure, plot(td.time_plot,td.depth,<span class="string">'-'</span>), datetick(<span class="string">'x'</span>,<span class="string">'QQ-YY'</span>)
0149 xlabel(<span class="string">'Date'</span>), ylabel(<span class="string">'Depth, m'</span>)
0150 title(sprintf(<span class="string">'Subsampled and trimmed depth record for tag #%s'</span>,td.tagno))
0151</pre></div>
<hr><address>Generated on Tue 27-Sep-2016 19:23:04 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>